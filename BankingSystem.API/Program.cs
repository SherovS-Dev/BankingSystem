using BankingSystem.API.Interfaces;
using BankingSystem.API.Repositories;
using BankingSystem.API.Services;

var builder = WebApplication.CreateBuilder(args);

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ connection string
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection") 
    ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");

// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new Microsoft.OpenApi.Models.OpenApiInfo
    {
        Title = "Banking System API",
        Version = "v1",
        Description = "API Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ½ĞºĞ¾Ğ²ÑĞºĞ¸Ğ¼Ğ¸ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸",
        Contact = new Microsoft.OpenApi.Models.OpenApiContact
        {
            Name = "Banking System",
            Email = "support@bank.tj"
        }
    });
});

// Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸
builder.Services.AddScoped<IAccountRepository>(sp => new AccountRepository(connectionString));
builder.Services.AddScoped<ITransactionRepository>(sp => new TransactionRepository(connectionString));

// Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
builder.Services.AddScoped<ITransactionService>(sp =>
    new TransactionService(
        sp.GetRequiredService<ITransactionRepository>(),
        connectionString,
        sp.GetRequiredService<ILogger<TransactionService>>()
    ));

// CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});

var app = builder.Build();

// Middleware
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "Banking System API V1");
        c.RoutePrefix = string.Empty; // Swagger UI Ğ½Ğ° ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¼ Ğ¿ÑƒÑ‚Ğ¸
    });
}

app.UseHttpsRedirection();
app.UseCors("AllowAll");
app.UseAuthorization();
app.MapControllers();

Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
Console.WriteLine("ğŸš€ Banking System API ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!");
Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
Console.WriteLine($"ğŸ“Š Swagger UI: {(app.Environment.IsDevelopment() ? "http://localhost:5000" : "")}");
Console.WriteLine($"ğŸŒ API Base URL: http://localhost:5000/api");
Console.WriteLine("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

app.Run();